load("@bazel_skylib//rules:diff_test.bzl", "diff_test")

load("//test:rules.bzl",
     "compile_module_tests",
     "compile_signature_tests",
     "module_program_tests",
     "ocamlcc_diff_tests",
     "ocamlcc_diff_test",
     "test_program",
     "test_module",
     "test_signature",
)
load("//test/rules:inline_expect_module.bzl", "inline_expect_test")

test_suite(
    name = "warnings",
    tests  = [
        ":Deprecated_module_tests",
        ":Deprecated_module_assigment_tests",
        ":Deprecated_module_use_tests",
        ":Deprecated_warning_specs_test",
        ":W01_tests",
        ":W03_tests",
        ":W04_tests",
        ":W04_failure_tests",
        ":W06_tests",
        ":W32_tests",
        ":W32_sig_tests",
        ":W32b_tests",
        ":W33_tests",
        ":W45_tests",
        ":W47_inline_tests",
        ":W50_tests",
        ":W51_test",
        ":W51_bis_tests",
        ":W52_test",
        ":W53_tests",
        ":W54_tests",
        ":W55_tests",
        ":W55_flambda_tests",
        ":W58_tests",
        ":W59_tests",
        ":W60_tests",
        ":W60_sig_tests",
        ":W68_tests",
    ],
)

## NB: tests can be configured to make exceptions either warnings or errors.

# With warnings, the compile will write warnings to stderr and succeed
# with return code 0, and will produce the compiled output files (cmi,
# cmo/x).   Pass `--output_groups=all' to see all outputs.

# The makefiles use warnings, which we do by setting:
# rc_expected = 0,
# warnings = ["+A"]
# See case W03 below for a commented example.

# With errors, the compile will write the same warnings to stderr, but
# will fail with return code 2, and will not produce compiled output
# files. Only stdout and stderr files will be output (if specified).

# To run with errors, set rc_expected=2 and omit warnings - the
# test_module rule will set '-w @A' by default, making all exceptions
# errors.
# As a demo, test W01 below is configured with errors.

## NOTE: stderr_actual is required if the compile is expected to write
## to stderr. It can be any file name (without path); the test_module
## rule will redirect stderr to the file specified.

## NOTE: compile outputs are written to a workdir, e.g.
## bazel-bin/testsuite/tests/warnings/_BS_vv/W04.cmo

## But the stderr_actual file (and/or stdout_actual) is not written to
## the workdir, e.g. bazel-bin/testsuite/tests/warnings/w04.ml.stderr

## NOTE: warning '-w -70' is automatically added if the module has no
## sigfile.

## WARNING: the documentation in the manual is very misleading. "If a
## warning is disabled, it isn’t displayed and doesn’t affect
## compilation in any way (even if it is fatal)." It may not affect
## compilation but it does affect the behavior of the compiler: the
## warning gets written to stderr even if it is "disabled". If it is
## disabled, the compile return code will be 0; if enabled, the rc
## will be 2.  But in both cases the warning is written to stderr.

## The compiler's default setting is:
## -w +a-4-6-7-9-27-29-32..42-44-45-48-50-60

## This "disables" these exceptions, which means if raised, warnings
## will always be written to stderr, but the return code and compiled
## outputs will not be affected.

## So for example, code with 4 (fragile-match) will emit a warning
## even if it is not explicitly listed on the command line. But for
## the sake of clarity the test targets here always list exceptions
## explicitly.

## ALERT: if you get errors like  "Error: Unbound value +",
## you probably need to add 'stdlib_deps = ["//stdlib:Stdlib"]'

#####################
compile_module_tests(
    name            = "Deprecated_module_tests",
    structfile      = "deprecated_module.ml",
    cmi             = ":Deprecated_module_cmi",
    stdlib_deps     = ["//stdlib:Stdlib"],
    alerts          = ["deprecated"],
    stderr_expected = "deprecated_module.compilers.reference",
    stderr_actual   = "deprecated_module.ml.stderr",
)

compile_signature_tests(
    name            = "Deprecated_module_sig_tests",
    sigfile         = "deprecated_module.mli",
    # WARNING: this will NOT print alerts to stderr, even though the
    # mli file contains deprecations:
    alerts = ["+deprecated"],
    stderr_expected = "deprecated_module.mli.stderr.expected",
    stderr_actual = "deprecated_module.mli.stderr",
)

#####################
compile_module_tests(
    ## WARNING: note the misspelling of 'assignment'
    name            = "Deprecated_module_assigment_tests",
    structfile      = "deprecated_module_assigment.ml",
    stdlib_deps = ["//stdlib:CamlinternalOO"],
    alerts = ["deprecated"],
    stderr_expected = ":deprecated_module_assigment.compilers.reference",
    stderr_actual   = "deprecated_module_assigment.ml.stderr",
)

#####################
compile_module_tests(
    name            = "Deprecated_module_use_tests",
    structfile      = "deprecated_module_use.ml",
    deps            = [":Deprecated_module"],
    alerts          = ["deprecated"],
    stderr_expected = "deprecated_module_use.compilers.reference",
    stderr_actual   = "deprecated_module_use.ml.stderr",
)

#####################
compile_module_tests(
    name            = "Deprecated_mutable_tests",
    structfile      = "deprecated_mutable.ml",
    deps            = [":Deprecated_module"],
    alerts          = ["deprecated"],
    stderr_expected = "deprecated_mutable.compilers.reference",
    stderr_actual   = "deprecated_mutable.ml.stderr",
)

################
inline_expect_test(
    name   = "Deprecated_warning_specs_test",
    struct = "deprecated_warning_specs.ml",
)

################################################################
compile_module_tests(
    name            = "W01_tests",
    structfile      = "w01.ml",
    stdlib_deps = ["//stdlib"],
    opts = ["-no-strict-sequence"],
    stderr_expected = ":w01.compilers.reference",
    stderr_actual  = "w01.ml.stderr",
    # as warnings:
    # rc_expected = 0,
    warnings = [
        "comment-not-end",             # 2
        "ignored-partial-application", # 5
        "partial-match",               # 8
        "non-unit-statement",          # 10
        "redundant-case",              # 11
        "unused-var-strict"            # 27
    ]
    # as errors (diff test will fail):
    # rc_expected = 2,
    # warnings = ["@A"]
)

#####################
compile_module_tests(
    name            = "W03_tests",
    structfile      = "w03.ml",
    alerts          = ["deprecated"], # default: makes the alert a warning
    stderr_expected = ":w03.compilers.reference",
    stderr_actual   = "w03.ml.stderr",
    timeout         = "short"
)

# ocamlcc_diff_tests(
#     name = "W03_tests",
#     expected = "w03.compilers.reference",
#     actual   = ":w03.ml.stderr",
#     tags = ["warnings"],
# )

# test_module(
#     name   = "W03",
#     struct = "w03.ml",
#     stderr_actual  = "w03.ml.stderr",
#     alerts = ["deprecated"], # default: makes the alert a warning
#     # warning '-70' is added automatically, since we have no .mli
#     # rc_expected defaults to 0
# )

#####################
compile_module_tests(
    name            = "W04_tests",
    structfile      = "w04.ml",
    warnings        = ["fragile-match"], # 4
    stderr_expected = ":w04.compilers.reference",
    stderr_actual   = "w04.ml.stderr",
    timeout         = "short"
)

# ocamlcc_diff_tests(
#     name = "W04_tests",
#     expected = "w04.compilers.reference",
#     actual   = ":w04.ml.stderr",
#     tags = ["warnings"],
# )

# test_module(
#     name   = "W04",
#     struct = "w04.ml",
#     stderr_actual  = "w04.ml.stderr",
#     warnings = ["fragile-match"] # 4
# )

#####################
compile_module_tests(
    name            = "W04_failure_tests",
    structfile      = "w04_failure.ml",
    warnings        = ["fragile-match"], # 4
    stderr_expected = ":w04_failure.compilers.reference",
    stderr_actual   = "w04_failure.ml.stderr",
)

# ocamlcc_diff_tests(
#     name = "W04_failure_tests",
#     expected = "w04_failure.compilers.reference",
#     actual   = ":w04_failure.ml.stderr",
#     tags = ["warnings"],
# )

# test_module(
#     name   = "W04_failure",
#     struct = "w04_failure.ml",
#     stderr_actual  = "w04_failure.ml.stderr",
#     warnings = ["fragile-match"] # 4
# )

#####################
compile_module_tests(
    name            = "W06_tests",
    structfile      = "w06.ml",
    stdlib_deps     = ["//stdlib:Stdlib"],
    warnings        = ["labels-omitted"], # 6
    stderr_expected = ":w06.compilers.reference",
    stderr_actual   = "w06.ml.stderr",
)

# ocamlcc_diff_tests(
#     name = "W06_tests",
#     expected = "w06.compilers.reference",
#     actual   = ":w06.ml.stderr",
#     tags = ["warnings"],
# )

# test_module(
#     name   = "W06",
#     struct = "w06.ml",
#     stdlib_deps = ["//stdlib:Stdlib"],
#     stderr_actual  = "w06.ml.stderr",
#     warnings = ["labels-omitted"] # 6
# )

#####################
## ALERT: this case conflates .ml and .mli compilation.
## We split the expected stderr, w32.compilers.reference,
## into two files, w32.ml.stderr.expected and w32.mli.stderr.expected
## and test separately.
compile_module_tests(
    name            = "W32_tests",
    structfile      = "w32.ml",
    cmi             = ":W32_cmi", # generated by compile_signature_tests below
    warnings        = [
        "unused-functor-parameter", # 67
        "unused-rec-flag",          # 39
        "unused-value-declaration", # 32
        "unused-module"             # 60
    ],
    ## splitting w32.compilers.reference:
    stderr_expected = "w32.ml.stderr.expected",
    stderr_actual   = "w32.ml.stderr",
)

compile_signature_tests(
    name            = "W32_sig_tests",
    sigfile         = "w32.mli",
    warnings        = ["unused-functor-parameter"],
    ## splitting w32.compilers.reference:
    stderr_expected = ":w32.mli.stderr.expected",
    stderr_actual = "w32.mli.stderr",
)

#####################
compile_module_tests(
    name            = "W32b_tests",
    structfile      = "w32b.ml",
    warnings        = [
        "unused-type-declaration", # 34
        "unused-module"            # 60
    ],
    stderr_expected = ":w32b.compilers.reference",
    stderr_actual   = "w32b.ml.stderr",
)

#####################
compile_module_tests(
    name            = "W33_tests",
    structfile      = "w33.ml",
    warnings        = [
        "unused-open",         # 33
        "unused-open-bang",    # 66
    ],
    stderr_expected = ":w33.compilers.reference",
    stderr_actual   = "w33.ml.stderr",
)

#####################
compile_module_tests(
    name            = "W45_tests",
    structfile      = "w45.ml",
    stdlib_deps     = ["//stdlib:Stdlib"],
    warnings        = [
        "open-shadow-label-constructor", # 45
        "ambiguous-name",                # 41
        "unused-open",                   # 33
    ],
    stderr_expected = ":w45.compilers.reference",
    stderr_actual   = "w45.ml.stderr",
)

#####################
compile_module_tests(
    name            = "W47_inline_tests",
    structfile      = "w47_inline.ml",
    stdlib_deps     = ["//stdlib:Stdlib"],
    warnings        = [
        "unused-var",          # 26
        "attribute-payload",   # 47
        "inlining-impossible"  # 55
    ],
    stderr_expected = ":w47_inline.compilers.reference",
    stderr_actual   = "w47_inline.ml.stderr",
)

#####################
compile_module_tests(
    name            = "W50_tests",
    structfile      = "w50.ml",
    stdlib_deps     = ["//stdlib:Stdlib.List"],
    warnings        = ["unused-module"], # 60
    stderr_expected = ":w50.compilers.reference",
    stderr_actual   = "w50.ml.stderr",
)

################
inline_expect_test(
    name        = "W51_test",
    struct  = "w51.ml",
    stdlib_deps = ["//stdlib:Stdlib"],
    warnings    = ["-A",
                   "+attribute-payload",         # 47
                   "+wrong-tailcall-expectation"] # 51
)

#####################
compile_module_tests(
    name            = "W51_bis_tests",
    structfile      = "w51_bis.ml",
    warnings        = ["wrong-tailcall-expectation"], # 51
    stderr_expected = ":w51_bis.compilers.reference",
    stderr_actual   = "w51_bis.ml.stderr",
)

################
inline_expect_test(
    name        = "W52_test",
    struct      = "w52.ml",
    stdlib_deps = ["//stdlib:Stdlib"],
    warnings    = ["-A", "+fragile-literal-pattern"]
)

#####################
## NOTE: only for vm-emitting compilers
compile_module_tests(
    name            = "W53_tests",
    compilers       = ["ocamlc.byte", "ocamlc.opt"],
    structfile      = "w53.ml",
    stdlib_deps     = ["//stdlib:Stdlib.Int32",
                       "//stdlib:Stdlib.Set"],
    warnings        = [
        "unused-value-declaration", # 32
        "misplaced-attribute",      # 53
    ],
    stderr_expected = ":w53.compilers.reference",
    stderr_actual   = "w53.ml.stderr",
)

#####################
compile_module_tests(
    name            = "W54_tests",
    structfile      = "w54.ml",
    warnings = ["duplicated-attribute"], # 54
    stderr_expected = ":w54.compilers.reference",
    stderr_actual   = "w54.ml.stderr",
)

#####################
## NOTE: different compilers expect different stderr, so we need 3 testsuites
# 1. verify that vm compilers do not report any warnings to stderr:
# To verify that the test logic works, add the following to w55.ml
# let foo = ( *\);;
# this will trigger a comment-not-end warning that will be written to stderr
test_suite(
    name = "W55_tests",
    tests  = [
        ":W55_vm_tests",
        ":W55_sys_tests",
        ":W55_flambda_tests",
    ]
)

compile_module_tests(
    name            = "W55_vm_tests",
    compilers       = ["ocamlc.byte", "ocamlc.opt"],
    structfile      = "w55.ml",
    stdlib_deps     = ["//stdlib:Stdlib"],
    stderr_expected = None,
    stderr_actual   = "w55.ml.vm.stderr",  # expected to be empty
)

# 2. std native compilers
compile_module_tests(
    name            = "W55_sys_tests",
    compilers       = ["ocamlopt.byte", "ocamlopt.opt"],
    structfile      = "w55.ml",
    stdlib_deps     = ["//stdlib:Stdlib"],
    warnings        = ["+A", "inlining-impossible"], # 55
    stderr_expected = ":w55.native.reference",
    stderr_actual   = "w55.ml.sys.stderr",
)

# 3. flambda compilers
compile_module_tests(
    name            = "W55_flambda_tests",
    compilers       = ["ocamloptx.byte", "ocamloptx.opt",  "ocamloptx.optx"],
    structfile      = "w55.ml",
    stdlib_deps     = ["//stdlib:Stdlib"],
    warnings        = ["inlining-impossible"], # 55
    stderr_expected = "w55.flambda.reference",
    stderr_actual   = "w55.ml.stderr",
)

#####################
test_suite(
    name = "W58_tests",
    tests  = [
        ":W58_vm_tests",
        ":W58_sys_tests",
    ]
)


## WARNING: warning only prints for ocamlopt, not ocamlc
compile_module_tests(
    name            = "W58_sys_tests",
    compilers       = ["ocamlopt.byte", "ocamlopt.opt",
                       "ocamloptx.byte", "ocamloptx.opt",
                       "ocamloptx.optx"],
    structfile      = "w58.ml",
    opts            = ["-no-opaque"],
    stdlib_deps     = ["//stdlib:Stdlib"],
    sig_deps        = ["Module_without_cmx_cmi"],
    warnings        = ["+A"], # "+no-cmx-file"],         # 58
    stderr_expected = "w58.native.reference",
    stderr_actual   = "w58.ml.stderr",
)

compile_module_tests(
    name            = "W58_vm_tests",
    compilers       = ["ocamlc.byte", "ocamlc.opt"],
    structfile      = "w58.ml",
    opts            = ["-no-opaque"],
    stdlib_deps     = ["//stdlib:Stdlib"],
    sig_deps        = ["Module_without_cmx_cmi"],
    warnings        = ["+A"], # "+no-cmx-file"],         # 58
    stderr_actual   = "w58.ml.vm.stderr",  # should be empty
)

test_signature(
    name = "Module_without_cmx_cmi",
    src  = "module_without_cmx.mli",
    opts   = ["-no-opaque"],
)

#####################
test_suite(
    name = "W59_tests",
    tests  = [
        ":W59_vm_tests",
        ":W59_sys_tests",
        ":W59_flambda_tests",
    ]
)

compile_module_tests(
    name            = "W59_vm_tests",
    compilers       = ["ocamlc.byte", "ocamlc.opt"],
    structfile      = "w59.ml",
    stdlib_deps     = ["//stdlib:Stdlib.Lazy"],
    stderr_expected = None,
    stderr_actual   = "w59.ml.vm.stderr",
)

compile_module_tests(
    name            = "W59_sys_tests",
    compilers       = ["ocamlopt.byte", "ocamlopt.opt"],
    structfile      = "w59.ml",
    stdlib_deps     = ["//stdlib:Stdlib.Lazy"],
    opts            = ["-dflambda-invariants"],
    warnings        = ["flambda-assignment-to-non-mutable-value"], # 59
    stderr_expected = None,
    stderr_actual   = "w59.ml.sys.stderr",
)

compile_module_tests(
    name            = "W59_flambda_tests",
    compilers       = ["ocamloptx.byte", "ocamloptx.opt", "ocamloptx.optx"],
    structfile      = "w59.ml",
    stdlib_deps     = ["//stdlib:Stdlib.Lazy"],
    opts            = ["-dflambda-invariants"],
    warnings        = ["flambda-assignment-to-non-mutable-value"], # 59
    stderr_expected = "w59.flambda.reference",
    stderr_actual   = "w59.ml.flambda.stderr",
)

#####################
compile_module_tests(
    name            = "W60_tests",
    structfile      = "w60.ml",
    cmi             = "W60_cmi",
    stdlib_deps     = ["//stdlib:Stdlib"],
    warnings = ["unused-module"], # 60
    stderr_expected = ":w60.compilers.reference",
    stderr_actual   = "w60.ml.stderr",
)

compile_signature_tests(
    name            = "W60_sig_tests",
    sigfile         = "w60.mli",
    warnings        = ["unused-functor-parameter"], # 67
    stderr_expected = "w60.mli.stderr.expected",
    stderr_actual   = "w60.mli.stderr",
)

################
module_program_tests(
    name            = "W68_tests",
    compilers       = ["ocamlopt.byte", "ocamlopt.opt", "ocamlopt.optx",
                 "ocamloptx.optx", "ocamloptx.opt", "ocamloptx.byte"],
    structfile      = "w68.ml",
    stdlib_deps     = ["//stdlib:Stdlib", "//stdlib:Stdlib.Gc"],
    warnings        = [
        "partial-match",                         # 8
        "match-on-mutable-state-prevent-uncurry" # 68
    ],
    stdout_expected = "w68.reference",
)
