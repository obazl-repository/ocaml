load("@bazel_skylib//rules:diff_test.bzl", "diff_test")
load("//test:rules.bzl",
     "test_executable_macro",
     "test_library",
     "test_module",
     "test_signature",
     "batch_test_macro",
     "batch_vv_test",
     "inline_expect_module",
     "compile_dump_diff_test_macro"
)

load("//config:WARNINGS.bzl", "w")

test_suite(
    name = "basic-modules",
    tests = [
        ":Anonymous_test",
        ":Main_expect_test",
        ":Recursive_module_init_expect_test",
        ":Recursive_module_evaluation_errors_test",
    ],
)

compile_dump_diff_test_macro(
    name   = "Anonymous_test",
    test_module = ":Anonymous",
    logfile_actual = ":anonymous.ml.lambda",
    vm_expected = "anonymous.ocamlc.reference",
    sys_expected = "anonymous.ocamlopt.reference",
    flambda_expected = "anonymous.ocamlopt.flambda.reference",
    tags = ["lambda"]
)

test_module(
    name   = "Anonymous",
    struct   = "anonymous.ml",
    logfile_actual = "anonymous.ml.lambda",
    dump = [
        "lambda",
        # "rawlambda",
        # "parsetree",
        # "instr",
        # "cmm",         ## native
        # "clambda",     ## native
        # "rawclambda",  ## native
        # "instruction-selection" # native?
    ],
    opts   = ["-dno-unique-ids"],
    stdlib_deps = ["//stdlib:CamlinternalMod"],
    warnings = [w.UNUSED_TYPE_DECLARATION_34, w.UNUSED_VALUE_DECLARATION_32]
)

batch_test_macro(
    name     = "Main_expect_test",
    test_module = ":Main",
    stdout_actual   = "Main.stdout",
    stdout_expected = "main.reference",
    timeout = "short"
)

test_module(
    name   = "Main",
    struct = "main.ml",
    sig    = "Main_cmi",
    deps   = [
        ":Offset",
        ":Pr4008",
        ":Pr7427",
        ":Pr6726"
    ],
    stdlib_deps = [
        "//stdlib:Stdlib.Printf",
        "//stdlib:Stdlib.Set",
    ],
    warnings = [w.UNUSED_MODULE_60, w.UNUSED_VALUE_DECLARATION_32]
)

test_signature(
    name = "Main_cmi",
    src  = "main.mli",
    stdlib_deps = ["//stdlib:Stdlib_cmi"]
)

test_module(
    name   = "Offset",
    struct = "offset.ml",
    deps   = [
        ":Pr6726"
    ],
    stdlib_deps = [
        "//stdlib:Stdlib.Set",
        "//stdlib:Stdlib.String",
    ],
    warnings = [w.UNUSED_VALUE_DECLARATION_32, w.UNUSED_VAR_STRICT_27]
)

test_module(
    name   = "Pr4008",
    struct = "pr4008.ml",
    stdlib_deps   = [
        "//stdlib:CamlinternalMod",
        "//stdlib:Stdlib.List",
    ]
)

test_module(
    name   = "Pr6726",
    struct = "pr6726.ml",
    stdlib_deps = ["//stdlib:Stdlib"],
    warnings = [w.UNUSED_VAR_STRICT_27]
)

test_module(
    name   = "Pr7427",
    struct = "pr7427.ml",
    stdlib_deps = ["//stdlib:Stdlib"]
)

################################################################
diff_test(
    name = "Recursive_module_evaluation_errors_test",
    file1 = "recursive_module_evaluation_errors.ml",
    file2 = ":Recursive_module_evaluation_errors",
    timeout = "short",
    tags = ["inline_expect"]
)

inline_expect_module(
    name = "Recursive_module_evaluation_errors",
    struct  = "recursive_module_evaluation_errors.ml",
    stdlib_deps = [
        ## FIXME: deps ordering not working, these must be listed in
        ## this order. This should happen automatically.
        "//stdlib:CamlinternalMod",
        "//stdlib:Stdlib",
    ],
)

################################################################
batch_test_macro(
    name     = "Recursive_module_init_expect_test",
    test_module = ":Recursive_module_init",
    stdout_actual   = "Recursive_module_init.stdout",
    stdout_expected = "recursive_module_init.reference",
    timeout = "short"
)

test_module(
    name   = "Recursive_module_init",
    struct = "recursive_module_init.ml",
    # dump = ["lambda"],
    stdlib_deps = [
        # "//stdlib:Primitives",
        "//stdlib:CamlinternalOO",
        "//stdlib:CamlinternalMod",
        "//stdlib:Stdlib.List",
        "//stdlib:Stdlib.Printf",
    ]
)

