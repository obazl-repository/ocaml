load("//test:rules.bzl",
     "batch_tests",
     "compile_module_tests",
     "module_program_tests",
     "ocamlcc_diff_tests",
     "test_module",
)

test_suite(
    name = "typing-missing-cmi",
    tests  = [":Main_tests",
              ":Main_ok_tests"]
)

compile_module_tests(
    name            = "Main_tests",
    structfile      = "main.ml",
    deps   = [":A", ":B"],
    stdlib_deps   = ["//stdlib:Stdlib"],
    suppress_cmi = ["//testsuite/tests/typing-missing-cmi/subdir:M"],
    rc_expected = 2,
    stderr_expected = ":test.compilers.reference",
    stderr_actual   = "main.ml.stderr",
)

compile_module_tests(
    name            = "Main_ok_tests",
    structfile      = "main_ok.ml",
    deps   = [":C"],
    stderr_actual   = "main_ok.ml.stderr", # should be empty
)

test_module(
    name   = "A",
    struct = "a.ml",
    deps = ["//testsuite/tests/typing-missing-cmi/subdir:M"]
)

test_module(
    name   = "B",
    struct = "b.ml",
    deps   = ["//testsuite/tests/typing-missing-cmi/subdir:M"]
)

test_module(
    name   = "C",
    struct = "c.ml",
    deps   = ["//testsuite/tests/typing-missing-cmi/subdir:M"]
)
